<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pencatatan Hutang Pelanggan</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        form {
            margin-bottom: 20px;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            width: 100%;
            box-sizing: border-box;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .debt-list {
            margin-top: 20px;
        }
        .debt-item {
            background-color: #f9f9f9;
            padding: 15px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .debt-item button {
            background-color: #f44336;
            color: white;
            border: none;
            cursor: pointer;
            padding: 8px 15px;
            margin-left: 10px;
        }
        .debt-item button:hover {
            background-color: #d32f2f;
        }
        .debt-item p {
            margin: 0;
            flex: 1;
            text-align: left;
        }
        .payment-form {
            display: flex;
            margin-top: 10px;
            justify-content: space-between;
            width: 100%;
        }
        .payment-form input {
            width: 70%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .payment-form button {
            width: 28%;
            padding: 10px;
            background-color: #4caf50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .payment-form button:hover {
            background-color: #45a049;
        }
        .debt-amount {
            font-weight: bold;
            color: #f44336;
        }
        .payment-history {
            margin-top: 10px;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 4px;
            width: 100%;
        }
        .payment-history span {
            display: block;
        }
        .debt-lunas {
            color: green;
            font-weight: bold;
        }
        .delete-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .payment-history div {
            margin-bottom: 10px; /* Spasi antara setiap pembayaran */
        }
        .payment-history hr {
            border: 1px solid #ccc;
            margin: 10px 0;
        }
        .tagih-button {
            background-color: #25d366 !important; /* Warna hijau WhatsApp */
            color: white;
            padding: 8px 15px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            text-align: center;
        }
        .tagih-button:hover {
            background-color: #128c7e !important; /* Warna hijau lebih gelap saat hover */
        }
        .total-debt {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px; /* Agar lebih dekat dengan daftar hutang */
            color: #333;
        }
        .delete-all-payments-button {
            background-color: #ff9800; /* Warna oranye untuk tombol hapus semua riwayat pembayaran */
            color: white;
            padding: 8px 15px;
            border: none;
            cursor: pointer;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .delete-all-payments-button:hover {
            background-color: #fb8c00;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Sistem Pencatatan Hutang Pelanggan</h1>

    <!-- Total Hutang dan Pembayaran --> 
    <div class="total-debt">
        <p>Total Hutang: Rp <span id="totalDebtAmount">0</span></p>
        <p>Total Pembayaran: Rp <span id="totalPaymentsAmount">0</span></p>
    </div>

    <!-- Tombol untuk menghapus semua riwayat pembayaran -->
    <button class="delete-all-payments-button" onclick="deleteAllPayments()">Hapus Semua Riwayat Pembayaran</button>

    <form id="debtForm">
        <input type="text" id="customerName" placeholder="Nama Pelanggan" required>
        <input type="text" id="customerPhone" placeholder="Nomor HP (Mulai dengan 62)" required>
        <input type="number" id="debtAmount" placeholder="Jumlah Hutang" required>
        <button type="submit">Tambah Hutang</button>
    </form>

    <div class="debt-list" id="debtList">
        <h2>Daftar Hutang</h2>
        <!-- Daftar hutang akan muncul di sini -->
    </div>
</div>

<script>
    // Memeriksa apakah ada data hutang yang tersimpan di LocalStorage
    let debts = JSON.parse(localStorage.getItem('debts')) || [];

    // Fungsi untuk menampilkan daftar hutang dan mengurutkan berdasarkan hutang terbesar ke terkecil
    function displayDebts() {
    const debtList = document.getElementById('debtList');
    debtList.innerHTML = '<h2>Daftar Hutang</h2>'; // Reset konten

    let totalDebt = 0;
    let totalPayments = 0;

    if (debts.length === 0) {
        debtList.innerHTML += '<p>Tidak ada hutang tercatat.</p>';
        document.getElementById('totalDebtAmount').innerText = totalDebt.toLocaleString();
        document.getElementById('totalPaymentsAmount').innerText = totalPayments.toLocaleString();
        return;
    }

    // Mengurutkan berdasarkan hutang terbesar ke terkecil, dan hutang lunas di bagian bawah
    debts.sort((a, b) => {
        if (a.amount === 0 && b.amount === 0) return 0; // Jika keduanya lunas, urutkan normal
        if (a.amount === 0) return 1; // Jika a lunas, b di atas
        if (b.amount === 0) return -1; // Jika b lunas, a di atas
        return b.amount - a.amount; // Urutkan berdasarkan jumlah hutang
    });

    debts.forEach((debt, index) => {
        const debtItem = document.createElement('div');
        debtItem.classList.add('debt-item');
        debtItem.innerHTML = `
    <p>${debt.customerName} - ${debt.customerPhone} - <span class="debt-amount">Rp ${debt.amount.toLocaleString()}</span>
    ${debt.amount <= 0 ? '<span class="debt-lunas">Hutang Lunas</span>' : ''}</p>
    ${debt.amount > 0 ? `
        <button class="pay-button" data-index="${index}">Bayar</button>
        <div id="paymentForm${index}" class="payment-form" style="display: none;">
            <input type="number" id="paymentAmount${index}" placeholder="Jumlah Pembayaran" />
            <button class="confirm-payment" data-index="${index}">Konfirmasi Pembayaran</button>
        </div>
    ` : ''}
    <button onclick="addDebtAmount(${index})">Tambah Hutang</button>
    <div class="payment-history">
        <h4>Riwayat Pembayaran</h4>
        ${debt.payments.map(payment => {
            return `
                <span>
                    Tanggal: ${payment.date} | 
                    Pembayaran: Rp ${payment.paid.toLocaleString()} | 
                    Setelah: Rp ${payment.after.toLocaleString()}
                </span>
                <hr />
            `;
        }).join('')}
    </div>
    ${debt.amount <= 0 ? `<button onclick="removeCustomerData(${index})">Hapus Data</button>` : ''}
    <!-- Menghapus tombol Hapus Riwayat Pembayaran di sini -->
    <button class="tagih-button" onclick="tagihCustomer(${index})">Tagih via WhatsApp</button>
`;
        debtList.appendChild(debtItem);

        totalDebt += debt.amount;
        totalPayments += debt.payments.reduce((acc, payment) => acc + payment.paid, 0);
    });

    // Menampilkan total hutang dan total pembayaran
    document.getElementById('totalDebtAmount').innerText = totalDebt.toLocaleString();
    document.getElementById('totalPaymentsAmount').innerText = totalPayments.toLocaleString();

    // Menambahkan event listener untuk tombol bayar
    const payButtons = document.querySelectorAll('.pay-button');
    payButtons.forEach(button => {
        button.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            const paymentForm = document.getElementById(`paymentForm${index}`);

            // Toggle tampilan form pembayaran (show/hide)
            if (paymentForm.style.display === "none" || paymentForm.style.display === "") {
                paymentForm.style.display = "flex";
            } else {
                paymentForm.style.display = "none";
            }
        });
    });

    // Konfirmasi pembayaran
    const confirmPaymentButtons = document.querySelectorAll('.confirm-payment');
    confirmPaymentButtons.forEach(button => {
        button.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            const paymentAmount = parseInt(document.getElementById(`paymentAmount${index}`).value);

            if (isNaN(paymentAmount) || paymentAmount <= 0 || paymentAmount > debts[index].amount) {
                alert("Jumlah pembayaran tidak valid!");
                return;
            }

            // Memperbarui hutang dan riwayat pembayaran
            const date = new Date().toLocaleString();
            debts[index].amount -= paymentAmount;
            debts[index].payments.push({
                paid: paymentAmount,
                after: debts[index].amount,
                date: date
            });

            // Simpan ke LocalStorage
            localStorage.setItem('debts', JSON.stringify(debts));

            // Tampilkan kembali daftar hutang
            displayDebts();
        });
    });
}


    // Fungsi untuk menghapus semua riwayat pembayaran
    function deleteAllPayments() {
        debts.forEach(debt => {
            debt.payments = [];
        });
        localStorage.setItem('debts', JSON.stringify(debts));
        displayDebts();
    }

    // Fungsi untuk menambah hutang
    function addDebt() {
        const customerName = document.getElementById('customerName').value;
        const customerPhone = document.getElementById('customerPhone').value;
        const debtAmount = parseInt(document.getElementById('debtAmount').value);

        if (!customerName || !customerPhone || isNaN(debtAmount) || debtAmount <= 0) {
            alert('Harap lengkapi semua field dengan benar!');
            return;
        }

        debts.push({
            customerName,
            customerPhone,
            amount: debtAmount,
            payments: []
        });

        localStorage.setItem('debts', JSON.stringify(debts));
        displayDebts();

        document.getElementById('customerName').value = '';
        document.getElementById('customerPhone').value = '';
        document.getElementById('debtAmount').value = '';
    }

    // Fungsi untuk tagih lewat WhatsApp
    function tagihCustomer(index) {
        const debt = debts[index];
        const message = `Halo ${debts[index].customerName},\n\n
Hutang kamu di kami masih Rp ${debts[index].amount.toLocaleString()}. Bisa dibayarkan besok, ya? 😉\n\n
Kami tunggu pembayarannya! Terima kasih.`;
        const phoneNumber = debt.customerPhone.startsWith('62') ? debt.customerPhone : '62' + debt.customerPhone.slice(1);
        window.open(`https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`);
    }

    // Fungsi untuk menghapus data pelanggan
    function removeCustomerData(index) {
        debts.splice(index, 1);
        localStorage.setItem('debts', JSON.stringify(debts));
        displayDebts();
    }

    // Fungsi untuk menambah hutang
    function addDebtAmount(index) {
        const additionalAmount = prompt('Masukkan jumlah hutang tambahan:');
        const amount = parseInt(additionalAmount);
        if (!isNaN(amount) && amount > 0) {
            debts[index].amount += amount;
            localStorage.setItem('debts', JSON.stringify(debts));
            displayDebts();
        }
    }

    // Inisialisasi halaman
    document.getElementById('debtForm').addEventListener('submit', function(event) {
        event.preventDefault();
        addDebt();
    });

    // Menampilkan data hutang
    displayDebts();
</script>

</body>
</html>
